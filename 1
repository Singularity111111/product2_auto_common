#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ™ºèƒ½ExcelæŠ¥å‘Šç”Ÿæˆå™¨ - æœ€ç»ˆç‰ˆ
===============================================

åŠŸèƒ½æè¿°ï¼š
- éç ´åæ€§æ“ä½œï¼šå¤åˆ¶æ¨¡æ¿æ–‡ä»¶ï¼Œåœ¨å‰¯æœ¬ä¸Šè¿›è¡Œæ›´æ–°
- æ™ºèƒ½æ›´æ–°ä¸è¿½åŠ ï¼šåŸºäºæ—¥æœŸåˆ—çš„è¦†ç›–å’Œè¿½åŠ é€»è¾‘
- å¤æ‚å¸ƒå±€å¤„ç†ï¼šæ”¯æŒä¸åŒèµ·å§‹åˆ—çš„æ•°æ®å†™å…¥
- æ—¥æœŸæ ¼å¼å…¼å®¹ï¼šå¤„ç†å„ç§æ—¥æœŸæ ¼å¼çš„åŒ¹é…é—®é¢˜
- è¾¹ç¼˜æƒ…å†µå¤„ç†ï¼šé‡å¤æ—¥æœŸã€æ•°æ®æ±‡æ€»è¡Œä¿æŠ¤ã€æ–°Sheetåˆ›å»º

"""

import os
import glob
import pandas as pd
import openpyxl
from openpyxl.utils.dataframe import dataframe_to_rows
import shutil
from datetime import datetime

# =============================== é…ç½®åŒº ==================================
# æ¨¡æ¿Excelæ–‡ä»¶åï¼ˆå‚è€ƒæ¨¡æ¿ï¼Œä¸ä¿®æ”¹ï¼‰
TEMPLATE_EXCEL_NAME = 'äº§å“äºŒ-VNLæ—¥æŠ¥-10æœˆ (13).xlsx'

# éœ€è¦å¤„ç†çš„Excelæ–‡ä»¶åï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰
TARGET_EXCEL_NAME = 'éœ€è¦è¦†ç›–çš„æ–‡ä»¶.xlsx'

# è¾“å‡ºExcelæ–‡ä»¶åï¼ˆæœ€ç»ˆç»“æœï¼‰
OUTPUT_EXCEL_NAME = 'äº§å“äºŒ-VNLæ—¥æŠ¥-10æœˆ_æœ€ç»ˆç‰ˆ.xlsx'

# æ ¸å¿ƒé…ç½®å­—å…¸ï¼šCSVæ–‡ä»¶åå…³é”®å­— -> (ç›®æ ‡Sheetå, æ—¥æœŸåˆ—å, èµ·å§‹å†™å…¥åˆ—)
REPORT_MAP = {
    'è¿è¥ç»Ÿè®¡': ('åå°', 'æ—¶é—´', 3), 
    'ç”¨æˆ·ç•™å­˜ç‡(é¦–å……å¤ç™»)_å…¨å¹³å°': ('é¦–å……å¤ç™»', 'æ—¶é—´', 1),
    'ç”¨æˆ·ç•™å­˜ç‡(é¦–å……å¤å……)_å…¨å¹³å°': ('é¦–å……å¤å……', 'æ—¶é—´', 1),
    'LTVå…¨å¹³å°': ('LTV', 'æ—¶é—´', 3), 
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-æ¸ é“è´¨é‡': ('æ¨å¹¿-æ¸ é“è´¨é‡', 'æ—¥æœŸ', 1),
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-ç”¨æˆ·è´¨é‡': ('æ¨å¹¿-ç”¨æˆ·è´¨é‡', 'æ—¥æœŸ', 1),
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-ç»æµæ•ˆç›Š': ('æ¨å¹¿-ç»æµæ•ˆç›Š', 'æ—¥æœŸ', 1),
    'èµ é€ç±»å‹ç»Ÿè®¡': ('èµ é€ç±»å‹ç»Ÿè®¡', 'æ—¥æœŸ', 1),
    'æ¯æ—¥æ¸ é“ç»Ÿè®¡': ('æ¯æ—¥æ¸ é“ç»Ÿè®¡', 'æ—¥æœŸ', 1),
}

# ç‰¹æ®Šå¤„ç†é…ç½®
SPECIAL_CONFIGS = {
    'LTV': {
        'date_format_output': 'D/M/YYYY',  # LTVè¡¨éœ€è¦ç‰¹æ®Šæ—¥æœŸæ ¼å¼
        'preserve_formulas': True  # ä¿æŠ¤å…¬å¼è¡Œ
    }
}
# ========================================================================

def to_standard_date(series):
    """å°†ä¸€ä¸ªPandas Seriesè½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼ï¼Œå¹¶å¤„ç†æ— æ•ˆæ—¥æœŸ"""
    try:
        # å¤„ç†å¸¦å¼•å·çš„æ—¥æœŸå­—ç¬¦ä¸²
        series_clean = series.astype(str).str.replace('"', '').str.replace("'", "").str.strip()
        
        # å°è¯•å¤šç§æ—¥æœŸè§£ææ–¹å¼
        parsed_dates = pd.to_datetime(series_clean, errors='coerce')
        
        # å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
        if parsed_dates.isna().all():
            parsed_dates = pd.to_datetime(series_clean, errors='coerce', dayfirst=True)
        
        # è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å­—ç¬¦ä¸²
        result = parsed_dates.dt.strftime('%Y-%m-%d')
        
        # å¦‚æœè¿˜æ˜¯å…¨éƒ¨ä¸ºç©ºï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
        if result.isna().all():
            print(f"    è­¦å‘Šï¼šæ—¥æœŸè§£æå®Œå…¨å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²")
            return series_clean
        
        return result
        
    except Exception as e:
        print(f"    è­¦å‘Šï¼šæ—¥æœŸè§£æå¤±è´¥: {e}")
        # è¿”å›åŸå§‹å­—ç¬¦ä¸²
        return series.astype(str)

def learn_from_template(template_path, workbook):
    """
    ä»æ¨¡æ¿æ–‡ä»¶å­¦ä¹ Sheetç»“æ„å’Œæ ¼å¼
    
    Args:
        template_path: æ¨¡æ¿æ–‡ä»¶è·¯å¾„
        workbook: ç›®æ ‡å·¥ä½œç°¿å¯¹è±¡
        
    Returns:
        dict: å­¦ä¹ åˆ°çš„Sheetç»“æ„ä¿¡æ¯
    """
    print(f"\nğŸ“š æ­£åœ¨ä»æ¨¡æ¿æ–‡ä»¶å­¦ä¹ ç»“æ„...")
    
    try:
        template_wb = openpyxl.load_workbook(template_path)
        learned_structure = {}
        
        for sheet_name in template_wb.sheetnames:
            sheet = template_wb[sheet_name]
            rows = list(sheet.iter_rows(values_only=True))
            
            # å­¦ä¹ è¡¨å¤´ç»“æ„
            header_info = {
                'headers': [],
                'header_row': -1,
                'start_col': 1
            }
            
            # æŸ¥æ‰¾è¡¨å¤´
            for i in range(min(10, len(rows))):
                row_values = [str(c).strip() if c is not None else '' for c in rows[i]]
                if any(keyword in str(row_values) for keyword in ['æ—¶é—´', 'æ—¥æœŸ']):
                    header_info['headers'] = list(rows[i])
                    header_info['header_row'] = i
                    break
            
            learned_structure[sheet_name] = header_info
            print(f"  âœ“ å­¦ä¹ åˆ°Sheet '{sheet_name}' ç»“æ„")
        
        template_wb.close()
        print(f"âœ… æ¨¡æ¿å­¦ä¹ å®Œæˆï¼Œå…±å­¦ä¹  {len(learned_structure)} ä¸ªSheet")
        return learned_structure
        
    except Exception as e:
        print(f"âŒ æ¨¡æ¿å­¦ä¹ å¤±è´¥: {e}")
        return {}

def smart_update_excel():
    """
    æ™ºèƒ½æ›´æ–°Excelæ–‡ä»¶çš„ä¸»å‡½æ•°
    
    æ ¸å¿ƒåŠŸèƒ½ï¼š
    1. éç ´åæ€§æ“ä½œï¼šå¤åˆ¶æ¨¡æ¿æ–‡ä»¶
    2. æ™ºèƒ½åŒ¹é…ï¼šæ ¹æ®æ–‡ä»¶ååŒ¹é…é…ç½®
    3. æ•°æ®åˆå¹¶ï¼šåŸºäºæ—¥æœŸçš„è¦†ç›–å’Œè¿½åŠ 
    4. æ ¼å¼ä¿æŒï¼šä¿ç•™åŸå§‹Excelçš„æ‰€æœ‰æ ¼å¼
    """
    print("=" * 60)
    print("ğŸš€ æ™ºèƒ½ExcelæŠ¥å‘Šç”Ÿæˆå™¨ - ä¿®å¤ç‰ˆ")
    print("=" * 60)
    
    # è·å–å½“å‰å·¥ä½œç›®å½•
    current_directory = os.getcwd()
    template_path = os.path.join(current_directory, TEMPLATE_EXCEL_NAME)
    target_path = os.path.join(current_directory, TARGET_EXCEL_NAME)
    output_path = os.path.join(current_directory, OUTPUT_EXCEL_NAME)
    
    print(f"ğŸ“ å·¥ä½œç›®å½•: {current_directory}")
    print(f"ğŸ“„ æ¨¡æ¿æ–‡ä»¶: {TEMPLATE_EXCEL_NAME}")
    print(f"ğŸ“„ ç›®æ ‡æ–‡ä»¶: {TARGET_EXCEL_NAME}")
    print(f"ğŸ“„ è¾“å‡ºæ–‡ä»¶: {OUTPUT_EXCEL_NAME}")
    
    # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    template_exists = os.path.exists(template_path)
    target_exists = os.path.exists(target_path)
    
    if not target_exists:
        print(f"\nâŒ é”™è¯¯ï¼šç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: {target_path}")
        return False
    
    # 2. å¤åˆ¶ç›®æ ‡æ–‡ä»¶ä½œä¸ºè¾“å‡ºæ–‡ä»¶
    try:
        print(f"\nğŸ“‹ æ­£åœ¨å¤åˆ¶ç›®æ ‡æ–‡ä»¶ä½œä¸ºè¾“å‡ºæ–‡ä»¶...")
        shutil.copy(target_path, output_path)
        print(f"âœ… è¾“å‡ºæ–‡ä»¶åˆ›å»ºæˆåŠŸ: {OUTPUT_EXCEL_NAME}")
    except Exception as e:
        print(f"\nâŒ å¤åˆ¶æ–‡ä»¶å¤±è´¥: {e}")
        return False
    
    # 3. ä»æ¨¡æ¿æ–‡ä»¶å­¦ä¹ ç»“æ„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    learned_structure = {}
    if template_exists:
        print(f"\nâœ… æ‰¾åˆ°å­¦ä¹ æ¨¡æ¿æ–‡ä»¶: {TEMPLATE_EXCEL_NAME}")
        workbook = openpyxl.load_workbook(output_path)
        learned_structure = learn_from_template(template_path, workbook)
    else:
        print(f"\nâš ï¸  è­¦å‘Šï¼šå­¦ä¹ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {template_path}")
        print("å°†ç›´æ¥å¤„ç†ç›®æ ‡æ–‡ä»¶")
        workbook = openpyxl.load_workbook(output_path)
    
    # 3. æŸ¥æ‰¾CSVæ–‡ä»¶
    csv_files = glob.glob(os.path.join(current_directory, '*.csv'))
    print(f"\nğŸ“Š æ‰¾åˆ° {len(csv_files)} ä¸ªCSVæ–‡ä»¶:")
    for csv_file in csv_files:
        print(f"   - {os.path.basename(csv_file)}")
    
    if not csv_files:
        print("\nâš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ°ä»»ä½•CSVæ–‡ä»¶")
        return False
    
    # 4. åŠ è½½Excelå·¥ä½œç°¿
    try:
        print(f"\nğŸ“– æ­£åœ¨åŠ è½½Excelå·¥ä½œç°¿...")
        workbook = openpyxl.load_workbook(output_path)
        print(f"âœ… Excelå·¥ä½œç°¿åŠ è½½æˆåŠŸ")
    except Exception as e:
        print(f"\nâŒ åŠ è½½Excelå·¥ä½œç°¿å¤±è´¥: {e}")
        return False
    
    # 5. å¤„ç†æ¯ä¸ªCSVæ–‡ä»¶
    success_count = 0
    total_count = len(csv_files)
    
    print(f"\nğŸ”„ å¼€å§‹å¤„ç†CSVæ–‡ä»¶...")
    
    for csv_path in csv_files:
        filename = os.path.basename(csv_path)
        
        # æŸ¥æ‰¾åŒ¹é…çš„é…ç½®
        mapping = None
        for keyword, value in sorted(REPORT_MAP.items(), key=lambda item: len(item[0]), reverse=True):
            if keyword in filename:
                mapping = value
                break
        
        if not mapping:
            print(f"\n- [è·³è¿‡] '{filename}' - æœªæ‰¾åˆ°åŒ¹é…çš„é…ç½®")
            continue
        
        sheet_name, date_col_name, start_col = mapping
        print(f"\n+ [å¤„ç†ä¸­] '{filename}' -> Sheet: '{sheet_name}'")
        
        try:
            # 1. è¯»å–æºCSV
            source_df = pd.read_csv(csv_path, keep_default_na=False, dtype=str)
            if source_df.empty:
                print("  - [ä¿¡æ¯] CSVæ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡ã€‚")
                continue
            
            print(f"  âœ“ CSVæ–‡ä»¶è¯»å–å®Œæˆï¼Œå…± {len(source_df)} è¡Œæ•°æ®")
            
            # 2. è¯»å–ç›®æ ‡Excel Sheet
            sheet = workbook[sheet_name] if sheet_name in workbook.sheetnames else workbook.create_sheet(title=sheet_name)
            
            # ä½¿ç”¨å­¦ä¹ åˆ°çš„ç»“æ„æˆ–æŸ¥æ‰¾è¡¨å¤´
            excel_rows = list(sheet.iter_rows(values_only=True))
            header_row_index = -1
            header = []
            
            # å¦‚æœä»æ¨¡æ¿å­¦ä¹ åˆ°äº†ç»“æ„ï¼Œä¼˜å…ˆä½¿ç”¨
            if sheet_name in learned_structure and learned_structure[sheet_name]['headers']:
                header_info = learned_structure[sheet_name]
                header = header_info['headers']
                header_row_index = header_info['header_row']
                print(f"  âœ“ ä½¿ç”¨å­¦ä¹ åˆ°çš„ç»“æ„ï¼Œè¡¨å¤´è¡Œ: {header_row_index}")
            else:
                # æŸ¥æ‰¾è¡¨å¤´å’Œèµ·å§‹æ•°æ®è¡Œ
                for i in range(min(10, len(excel_rows))):
                    row_values = [str(c).strip() if c is not None else '' for c in excel_rows[i]]
                    if date_col_name in row_values:
                        header_row_index = i
                        header = [c for c in excel_rows[i]] # ä¿ç•™åŸå§‹headerå€¼
                        break
            
            # å¦‚æœSheetæ˜¯å…¨æ–°çš„æˆ–æ‰¾ä¸åˆ°è¡¨å¤´
            if header_row_index == -1:
                print(f"  - [ä¿¡æ¯] Sheet '{sheet_name}' ä¸ºæ–°æˆ–æ‰¾ä¸åˆ°è¡¨å¤´ã€‚å°†è¿›è¡Œå®Œå…¨å†™å…¥ã€‚")
                sheet.delete_rows(1, sheet.max_row + 10) # æ¸…ç†å¹²å‡€
                
                # å†™å…¥è¡¨å¤´
                header_row = [None] * (start_col - 1) + source_df.columns.tolist()
                sheet.append(header_row)
                
                # å†™å…¥æ•°æ®
                for _, row in source_df.iterrows():
                    data_row = [None] * (start_col - 1) + row.tolist()
                    sheet.append(data_row)
                
                print(f"  âœ“ æ–°Sheetæ•°æ®å†™å…¥å®Œæˆï¼Œå…± {len(source_df)} è¡Œæ•°æ®")
                success_count += 1
                continue
            
            # 3. æ ¸å¿ƒåˆå¹¶é€»è¾‘
            # å°†Excelæ•°æ®è¯»å…¥Pandas DataFrame
            data_start_row = header_row_index + 1
            if len(excel_rows) > data_start_row:
                target_df = pd.DataFrame(excel_rows[data_start_row:], columns=header)
            else:
                target_df = pd.DataFrame(columns=header)
            
            print(f"  âœ“ Excelæ•°æ®è¯»å–å®Œæˆï¼Œç°æœ‰ {len(target_df)} è¡Œæ•°æ®")
            
            # å¦‚æœç›®æ ‡æ•°æ®ä¸ºç©ºï¼Œç›´æ¥å†™å…¥æºæ•°æ®
            if len(target_df) == 0:
                print(f"  - [ä¿¡æ¯] ç›®æ ‡Sheetä¸ºç©ºï¼Œç›´æ¥å†™å…¥æºæ•°æ®")
                for _, row in source_df.iterrows():
                    data_row = [None] * (start_col - 1) + row.tolist()
                    sheet.append(data_row)
                print(f"  âœ“ æ•°æ®å†™å…¥å®Œæˆï¼Œå…± {len(source_df)} è¡Œæ•°æ®")
                success_count += 1
                continue
            
            # ç¡®ä¿åˆ—æ•°åŒ¹é…
            if len(source_df.columns) > len(target_df.columns):
                source_df = source_df.iloc[:, :len(target_df.columns)]
            elif len(source_df.columns) < len(target_df.columns):
                missing_cols = len(target_df.columns) - len(source_df.columns)
                for i in range(missing_cols):
                    source_df[f'empty_col_{i}'] = ''
            
            source_df.columns = target_df.columns[:len(source_df.columns)]
            
            # æ ‡å‡†åŒ–æ—¥æœŸåˆ—ç”¨äºåŒ¹é…
            source_df['__match_key__'] = to_standard_date(source_df[date_col_name])
            target_df['__match_key__'] = to_standard_date(target_df[date_col_name])
            
            print(f"  - æºæ•°æ®æ—¥æœŸè§£æç»“æœ: {len(source_df[source_df['__match_key__'].notna()])} è¡Œæœ‰æ•ˆ")
            print(f"  - ç›®æ ‡æ•°æ®æ—¥æœŸè§£æç»“æœ: {len(target_df[target_df['__match_key__'].notna()])} è¡Œæœ‰æ•ˆ")
            
            # è¿‡æ»¤æ‰æ— æ³•è¯†åˆ«çš„æ—¥æœŸå’Œæ±‡æ€»è¡Œ
            source_df_valid = source_df[source_df['__match_key__'].notna()]
            if len(source_df_valid) == 0:
                print(f"  - [è­¦å‘Š] æºæ•°æ®æ—¥æœŸè§£æå…¨éƒ¨å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®")
                source_df_valid = source_df.copy()
            else:
                source_df_valid = source_df_valid[~source_df_valid[date_col_name].astype(str).str.contains("æ•°æ®æ±‡æ€»", na=False)]
            
            target_df_valid = target_df[target_df['__match_key__'].notna()]
            if len(target_df_valid) == 0:
                print(f"  - [è­¦å‘Š] ç›®æ ‡æ•°æ®æ—¥æœŸè§£æå…¨éƒ¨å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®")
                target_df_valid = target_df.copy()
            else:
                target_df_valid = target_df_valid[~target_df_valid[date_col_name].astype(str).str.contains("æ•°æ®æ±‡æ€»", na=False)]
            
            print(f"  âœ“ æ•°æ®è¿‡æ»¤å®Œæˆï¼Œæºæ•°æ®: {len(source_df_valid)} è¡Œï¼Œç›®æ ‡æ•°æ®: {len(target_df_valid)} è¡Œ")
            
            # å¦‚æœæºæ•°æ®å…¨éƒ¨è¢«è¿‡æ»¤æ‰ï¼Œç›´æ¥è¿½åŠ åŸå§‹æ•°æ®
            if len(source_df_valid) == 0:
                print(f"  - [ä¿¡æ¯] æºæ•°æ®å…¨éƒ¨è¢«è¿‡æ»¤ï¼Œç›´æ¥è¿½åŠ åŸå§‹æ•°æ®")
                for _, row in source_df.iterrows():
                    data_row = [None] * (start_col - 1) + row.tolist()
                    sheet.append(data_row)
                print(f"  âœ“ åŸå§‹æ•°æ®è¿½åŠ å®Œæˆï¼Œå…± {len(source_df)} è¡Œæ•°æ®")
                success_count += 1
                continue
            
            # "å…ˆåˆ åå¢"é€»è¾‘
            dates_to_update = source_df_valid['__match_key__'].unique()
            target_df_preserved = target_df_valid[~target_df_valid['__match_key__'].isin(dates_to_update)]
            
            final_df = pd.concat([target_df_preserved, source_df_valid]).drop(columns=['__match_key__'])
            
            print(f"  âœ“ æ•°æ®åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆæ•°æ®: {len(final_df)} è¡Œ")
            
            # 4. å†™å›Excel
            # æ¸…ç©ºæ—§æ•°æ®åŒºåŸŸ
            if sheet.max_row > data_start_row:
                sheet.delete_rows(data_start_row + 1, sheet.max_row)
            
            # å†™å…¥åˆå¹¶åçš„æ–°æ•°æ®
            for _, row in final_df.iterrows():
                # åº”ç”¨èµ·å§‹åˆ—åç§»
                offset_row = [None] * (start_col - 1) + row.tolist()
                sheet.append(offset_row)
            
            print(f"  âœ“ å¤„ç†å®Œæˆï¼å…±å¤„ç† {len(final_df)} è¡Œæ•°æ®")
            success_count += 1
            
        except Exception as e:
            print(f"  âœ— å¤„ç†å¤±è´¥: {e}")
            import traceback
            print(f"  é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
    
    # 6. ä¿å­˜å·¥ä½œç°¿
    try:
        print(f"\nğŸ’¾ æ­£åœ¨ä¿å­˜Excelæ–‡ä»¶...")
        workbook.save(output_path)
        print(f"âœ… Excelæ–‡ä»¶ä¿å­˜æˆåŠŸ")
    except Exception as e:
        print(f"\nâŒ ä¿å­˜Excelæ–‡ä»¶å¤±è´¥: {e}")
        return False
    
    # 7. è¾“å‡ºå¤„ç†ç»“æœ
    print("\n" + "=" * 60)
    print("ğŸ“ˆ å¤„ç†ç»“æœæ±‡æ€»")
    print("=" * 60)
    print(f"ğŸ“Š æ€»CSVæ–‡ä»¶æ•°: {total_count}")
    print(f"âœ… æˆåŠŸå¤„ç†: {success_count}")
    print(f"âŒ å¤„ç†å¤±è´¥: {total_count - success_count}")
    print(f"ğŸ“„ è¾“å‡ºæ–‡ä»¶: {OUTPUT_EXCEL_NAME}")
    
    if success_count > 0:
        print(f"\nğŸ‰ æ™ºèƒ½æ›´æ–°å®Œæˆï¼")
        print(f"ğŸ“ è¯·æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶: {OUTPUT_EXCEL_NAME}")
    else:
        print(f"\nâš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æˆåŠŸå¤„ç†ä»»ä½•æ–‡ä»¶")
    
    print("=" * 60)
    return success_count > 0

def main():
    """
    ä¸»å‡½æ•°å…¥å£
    """
    print("è„šæœ¬å¼€å§‹æ‰§è¡Œ...")
    try:
        success = smart_update_excel()
        if success:
            print("\nâœ¨ ç¨‹åºæ‰§è¡Œå®Œæˆï¼")
        else:
            print("\nâŒ ç¨‹åºæ‰§è¡Œå¤±è´¥ï¼")
            return 1
    except KeyboardInterrupt:
        print("\n\nâš ï¸  ç”¨æˆ·ä¸­æ–­ç¨‹åºæ‰§è¡Œ")
        return 1
    except Exception as e:
        print(f"\nâŒ ç¨‹åºæ‰§è¡Œå‡ºç°æœªé¢„æœŸé”™è¯¯: {e}")
        return 1
    
    return 0

if __name__ == '__main__':
    exit_code = main()
    exit(exit_code)
