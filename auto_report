import os
import glob
import pandas as pd
import openpyxl
from openpyxl.utils.dataframe import dataframe_to_rows
import shutil
from datetime import datetime

# =============================== é…ç½®åŒº ==================================
SOURCE_EXCEL_NAME = 'äº§å“äºŒ-VNLæ—¥æŠ¥-10æœˆ (13).xlsx'
OUTPUT_EXCEL_NAME = SOURCE_EXCEL_NAME.replace('.xlsx', '_updated_v10.xlsx')

REPORT_MAP = {
    'è¿è¥ç»Ÿè®¡': ('åå°', 'æ—¶é—´', 3), 
    'ç”¨æˆ·ç•™å­˜ç‡(é¦–å……å¤ç™»)_å…¨å¹³å°': ('é¦–å……å¤ç™»', 'æ—¶é—´', 1),
    'ç”¨æˆ·ç•™å­˜ç‡(é¦–å……å¤å……)_å…¨å¹³å°': ('é¦–å……å¤å……', 'æ—¶é—´', 1),
    'LTVå…¨å¹³å°': ('LTV', 'æ—¶é—´', 3), 
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-æ¸ é“è´¨é‡': ('æ¨å¹¿-æ¸ é“è´¨é‡', 'æ—¥æœŸ', 1),
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-ç”¨æˆ·è´¨é‡': ('æ¨å¹¿-ç”¨æˆ·è´¨é‡', 'æ—¥æœŸ', 1),
    'æ¨å¹¿æ¸ é“ç»Ÿè®¡-ç»æµæ•ˆç›Š': ('æ¨å¹¿-ç»æµæ•ˆç›Š', 'æ—¥æœŸ', 1),
    'èµ é€ç±»å‹ç»Ÿè®¡': ('èµ é€ç±»å‹ç»Ÿè®¡', 'æ—¥æœŸ', 1),
    'æ¯æ—¥æ¸ é“ç»Ÿè®¡': ('æ¯æ—¥æ¸ é“ç»Ÿè®¡', 'æ—¥æœŸ', 1),
}
# ========================================================================

def to_standard_date(series):
    """å°†ä¸€ä¸ªPandas Seriesè½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼ï¼Œå¹¶å¤„ç†æ— æ•ˆæ—¥æœŸ"""
    return pd.to_datetime(series, errors='coerce').dt.strftime('%Y-%m-%d')

def smart_update_excel_v10():
    """
    æ™ºèƒ½æ›´æ–°Excel V10 ç‰ˆï¼š
    - æ ¸å¿ƒé‡æ„ï¼šä½¿ç”¨Pandasè¿›è¡Œæ ¸å¿ƒçš„æ•°æ®æ¯”å¯¹ä¸åˆå¹¶ï¼Œå½»åº•è§£å†³å› æ•°æ®ç±»å‹ä¸åŒ¹é…å¯¼è‡´çš„è¦†ç›–å¤±è´¥ã€‚
    """
    current_directory = os.getcwd()
    source_path = os.path.join(current_directory, SOURCE_EXCEL_NAME)
    output_path = os.path.join(current_directory, OUTPUT_EXCEL_NAME)

    print(f"--- å¯åŠ¨æ™ºèƒ½æ›´æ–°ç¨‹åº (V10 - æœ€ç»ˆç‰ˆ) ---")

    try:
        shutil.copy(source_path, output_path)
        print(f"âœ“ å·²åˆ›å»ºå®‰å…¨å‰¯æœ¬: {OUTPUT_EXCEL_NAME}")
    except Exception as e:
        print(f"\n[é”™è¯¯] åˆ›å»ºå‰¯æœ¬å¤±è´¥: {e}")
        return

    csv_files = glob.glob(os.path.join(current_directory, '*.csv'))
    print(f"âœ“ æ‰¾åˆ° {len(csv_files)} ä¸ªCSVæ–‡ä»¶å‡†å¤‡å¤„ç†...")

    try:
        workbook = openpyxl.load_workbook(output_path)
    except Exception as e:
        print(f"\n[é”™è¯¯] æ‰“å¼€Excelå‰¯æœ¬å¤±è´¥: {e}")
        return

    for csv_path in csv_files:
        filename = os.path.basename(csv_path)
        mapping = None
        for keyword, value in sorted(REPORT_MAP.items(), key=lambda item: len(item[0]), reverse=True):
            if keyword in filename:
                mapping = value
                break
        if not mapping:
            continue

        sheet_name, date_col_name, start_col = mapping
        print(f"\n+ [å¤„ç†ä¸­] '{filename}' -> Sheet: '{sheet_name}'")

        try:
            # 1. è¯»å–æºCSV
            source_df = pd.read_csv(csv_path, keep_default_na=False, dtype=str)
            if source_df.empty:
                print("  - [ä¿¡æ¯] CSVæ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡ã€‚")
                continue

            # 2. è¯»å–ç›®æ ‡Excel Sheet
            sheet = workbook[sheet_name] if sheet_name in workbook.sheetnames else workbook.create_sheet(title=sheet_name)
            
            # æ‰¾åˆ°è¡¨å¤´
            excel_rows = list(sheet.iter_rows(values_only=True))
            header_row_index = -1
            date_col_index = -1
            header = []
            for i in range(min(10, len(excel_rows))):
                row_values = [str(c).strip() if c is not None else '' for c in excel_rows[i]]
                if date_col_name in row_values:
                    header_row_index = i
                    header = row_values
                    break
            
            if header_row_index == -1 and sheet.max_row > 0: # è¡¨å­˜åœ¨ä½†æ‰¾ä¸åˆ°è¡¨å¤´
                 print(f"  - [è­¦å‘Š] åœ¨Sheet '{sheet_name}' ä¸­æ‰¾ä¸åˆ°è¡¨å¤´ '{date_col_name}'ã€‚å°†è¿›è¡Œç›´æ¥è¦†ç›–ã€‚")
                 sheet.delete_rows(1, sheet.max_row + 1) # æ¸…ç©º
                 for r in dataframe_to_rows(source_df, index=False, header=True):
                    sheet.append(r)
                 continue
            
            # å°†Excelæ•°æ®è¯»å…¥Pandas DataFrame
            if sheet.max_row > header_row_index + 1:
                target_df = pd.DataFrame(excel_rows[header_row_index+1:], columns=header)
            else:
                target_df = pd.DataFrame(columns=header)
            
            # 3. æ ¸å¿ƒï¼šæ ‡å‡†åŒ–æ—¥æœŸåˆ—ç”¨äºåŒ¹é…
            source_df.columns = target_df.columns[:len(source_df.columns)]
            source_df['__match_key__'] = to_standard_date(source_df[date_col_name])
            target_df['__match_key__'] = to_standard_date(target_df[date_col_name])
            
            # è¿‡æ»¤æ‰æ— æ³•è¯†åˆ«çš„æ—¥æœŸå’Œæ±‡æ€»è¡Œ
            source_df = source_df[source_df['__match_key__'].notna()]
            source_df = source_df[~source_df[date_col_name].str.contains("æ•°æ®æ±‡æ€»")]
            
            # 4. æ•°æ®åˆå¹¶
            # å°†DataFrameçš„ç´¢å¼•è®¾ç½®ä¸ºåŒ¹é…é”®
            target_df.set_index('__match_key__', inplace=True)
            source_df.set_index('__match_key__', inplace=True)
            
            # æ‰§è¡Œæ›´æ–°
            target_df.update(source_df)
            
            # æ‰¾å‡ºéœ€è¦è¿½åŠ çš„æ–°è¡Œ
            new_rows_df = source_df[~source_df.index.isin(target_df.index)]
            
            # åˆå¹¶æ—§æ•°æ®ã€æ›´æ–°æ•°æ®å’Œæ–°æ•°æ®
            final_df = pd.concat([target_df, new_rows_df])
            final_df.reset_index(inplace=True) # æ¢å¤ç´¢å¼•
            
            updates_count = len(source_df.index.intersection(target_df.index))
            appends_count = len(new_rows_df)

            # 5. å†™å›Excel
            # æ¸…ç©ºæ—§æ•°æ®åŒºåŸŸ
            if sheet.max_row > header_row_index + 1:
                sheet.delete_rows(header_row_index + 2, sheet.max_row)

            # å†™å…¥åˆå¹¶åçš„æ–°æ•°æ®
            for index, row in final_df.iterrows():
                # ä¿æŒåŸå§‹æ ¼å¼ï¼Œæ‰€ä»¥ä¸å†™å›__match_key__
                row_to_write = row.drop('__match_key__').to_list()
                
                # ç‰¹æ®Šå¤„ç†LTVæ—¥æœŸæ ¼å¼
                if sheet_name == 'LTV':
                    try:
                        date_obj = pd.to_datetime(row[date_col_name])
                        row_to_write[header.index(date_col_name)] = f"{date_obj.day}/{date_obj.month}/{date_obj.year}"
                    except: pass
                
                sheet.append(row_to_write)
            
            print(f"  âœ“ å¤„ç†å®Œæˆï¼šæ›´æ–°äº† {updates_count} è¡Œï¼Œè¿½åŠ äº† {appends_count} è¡Œã€‚")

        except Exception as e:
            import traceback
            print(f"  > [å¤±è´¥] å¤„ç†æ­¤æ–‡ä»¶æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
            # print(traceback.format_exc())

    try:
        workbook.save(output_path)
        print("\n" + "="*50)
        print(f"ğŸ‰ æ™ºèƒ½æ›´æ–°å®Œæ¯•ï¼å·²ç”Ÿæˆæ–°æ–‡ä»¶: {OUTPUT_EXCEL_NAME}")
        print("="*50)
    except Exception as e:
        print(f"\n[ä¸¥é‡é”™è¯¯] ä¿å­˜Excelæ–‡ä»¶å¤±è´¥: {e}")

if __name__ == '__main__':
    smart_update_excel_v10()
